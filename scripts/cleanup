#!/usr/bin/env bash
#
# cleanup - List and optionally remove stale skills/agents not in amplify source
#
# Usage: cleanup [--dry-run]
#
# Shows installed skills/agents that don't exist in the amplify source,
# letting you select which ones to remove.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AMPLIFY_DIR="$(dirname "$SCRIPT_DIR")"

DRY_RUN=false
if [[ "${1:-}" == "--dry-run" ]]; then
    DRY_RUN=true
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get source skills and agents
get_source_skills() {
    ls -1 "$AMPLIFY_DIR/skills" 2>/dev/null || true
}

get_source_agents() {
    ls -1 "$AMPLIFY_DIR/agents" 2>/dev/null | sed 's/\.md$//' || true
}

# Get installed items for each tool
get_opencode_skills() {
    ls -1 ~/.config/opencode/skill 2>/dev/null || true
}

get_opencode_agents() {
    ls -1 ~/.config/opencode/agent 2>/dev/null | sed 's/\.md$//' || true
}

get_claude_skills() {
    ls -1 ~/.claude/skills 2>/dev/null || true
}

get_claude_agents() {
    ls -1 ~/.claude/agents 2>/dev/null | sed 's/\.md$//' || true
}

get_codex_skills() {
    ls -1 ~/.codex/skills 2>/dev/null || true
}

get_amp_skills() {
    ls -1 ~/.config/amp/skills 2>/dev/null || true
}

# Find orphaned items (installed but not in source)
find_orphans() {
    local source_items="$1"
    local installed_items="$2"
    
    for item in $installed_items; do
        if ! echo "$source_items" | grep -qx "$item"; then
            echo "$item"
        fi
    done
}

# Main
echo -e "${BLUE}Amplify Cleanup${NC}"
echo "Scanning for skills/agents not in amplify source..."
echo ""

SOURCE_SKILLS=$(get_source_skills)
SOURCE_AGENTS=$(get_source_agents)

declare -a ORPHANS=()

# Check OpenCode
if [[ -d ~/.config/opencode/skill ]]; then
    OPENCODE_SKILL_ORPHANS=$(find_orphans "$SOURCE_SKILLS" "$(get_opencode_skills)")
    for item in $OPENCODE_SKILL_ORPHANS; do
        ORPHANS+=("opencode:skill:$item:$HOME/.config/opencode/skill/$item")
    done
fi

if [[ -d ~/.config/opencode/agent ]]; then
    OPENCODE_AGENT_ORPHANS=$(find_orphans "$SOURCE_AGENTS" "$(get_opencode_agents)")
    for item in $OPENCODE_AGENT_ORPHANS; do
        ORPHANS+=("opencode:agent:$item:$HOME/.config/opencode/agent/$item.md")
    done
fi

# Check Claude
if [[ -d ~/.claude/skills ]]; then
    CLAUDE_SKILL_ORPHANS=$(find_orphans "$SOURCE_SKILLS" "$(get_claude_skills)")
    for item in $CLAUDE_SKILL_ORPHANS; do
        ORPHANS+=("claude:skill:$item:$HOME/.claude/skills/$item")
    done
fi

if [[ -d ~/.claude/agents ]]; then
    CLAUDE_AGENT_ORPHANS=$(find_orphans "$SOURCE_AGENTS" "$(get_claude_agents)")
    for item in $CLAUDE_AGENT_ORPHANS; do
        ORPHANS+=("claude:agent:$item:$HOME/.claude/agents/$item.md")
    done
fi

# Check Codex
if [[ -d ~/.codex/skills ]]; then
    CODEX_SKILL_ORPHANS=$(find_orphans "$SOURCE_SKILLS" "$(get_codex_skills)")
    for item in $CODEX_SKILL_ORPHANS; do
        ORPHANS+=("codex:skill:$item:$HOME/.codex/skills/$item")
    done
fi

# Check Amp
if [[ -d ~/.config/amp/skills ]]; then
    AMP_SKILL_ORPHANS=$(find_orphans "$SOURCE_SKILLS" "$(get_amp_skills)")
    for item in $AMP_SKILL_ORPHANS; do
        ORPHANS+=("amp:skill:$item:$HOME/.config/amp/skills/$item")
    done
fi

if [[ ${#ORPHANS[@]} -eq 0 ]]; then
    echo -e "${GREEN}No orphaned skills or agents found.${NC}"
    exit 0
fi

echo -e "${YELLOW}Found ${#ORPHANS[@]} item(s) not in amplify source:${NC}"
echo ""

# Display orphans with numbers
for i in "${!ORPHANS[@]}"; do
    IFS=':' read -r tool type name path <<< "${ORPHANS[$i]}"
    printf "  %2d) [%s] %s: %s\n" "$((i+1))" "$tool" "$type" "$name"
done

echo ""
echo "These may be:"
echo "  - Old skills/agents removed from amplify"
echo "  - Your own custom skills/agents (don't delete these!)"
echo ""

if $DRY_RUN; then
    echo -e "${BLUE}Dry run - no changes made${NC}"
    exit 0
fi

echo "Enter numbers to remove (e.g., '1 3 5'), 'all', or 'none':"
read -r selection

if [[ "$selection" == "none" || -z "$selection" ]]; then
    echo "No items removed."
    exit 0
fi

if [[ "$selection" == "all" ]]; then
    indices=$(seq 0 $((${#ORPHANS[@]} - 1)))
else
    indices=""
    for num in $selection; do
        if [[ "$num" =~ ^[0-9]+$ ]] && [[ "$num" -ge 1 ]] && [[ "$num" -le ${#ORPHANS[@]} ]]; then
            indices="$indices $((num - 1))"
        else
            echo -e "${RED}Invalid selection: $num${NC}"
        fi
    done
fi

for idx in $indices; do
    IFS=':' read -r tool type name path <<< "${ORPHANS[$idx]}"
    echo -e "Removing [$tool] $type: $name"
    rm -rf "$path"
done

echo ""
echo -e "${GREEN}Done.${NC}"
